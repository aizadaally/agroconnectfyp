<!-- frontend/templates/frontend/product_detail.html -->
{% extends 'frontend/base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{{ product.get_translated_name }} - AgroConnect{% endblock %}

{% block extra_css %}
<style>
    .kyrgyz-product-hero {
        background: linear-gradient(to bottom, var(--bg-secondary), var(--bg-primary));
        padding: 40px 0;
        border-radius: 15px;
        margin-bottom: 40px;
    }
    
    .product-image-container {
        position: relative;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 8px 25px var(--shadow);
    }
    
    .naryn-origin-badge {
        background: linear-gradient(45deg, var(--bg-success), #229954);
        color: white;
        padding: 8px 20px;
        border-radius: 25px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
    }
    
    .farmer-card-kyrgyz {
        background: var(--bg-secondary);
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 4px 15px var(--shadow);
        position: relative;
        overflow: hidden;
    }
    
    .farmer-avatar-kyrgyz {
        width: 100px;
        height: 100px;
        border-radius: 15px;
        object-fit: cover;
        border: 3px solid var(--bg-success);
        box-shadow: 0 4px 15px var(--shadow);
    }
    
    .quality-badges {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 20px;
    }
    
    .quality-badge {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        padding: 8px 16px;
        border-radius: 25px;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9rem;
    }
    
    .quality-badge i {
        color: var(--bg-success);
    }
    
    .naryn-map-section {
        background: var(--bg-secondary);
        border-radius: 15px;
        padding: 30px;
        margin-top: 40px;
        position: relative;
    }
    
    .map-overlay {
        position: absolute;
        top: 20px;
        right: 20px;
        background: var(--bg-primary);
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 0.9rem;
        border: 1px solid var(--border-color);
        z-index: 10;
    }
    
    .related-products-section {
        background: url('/media/kyrgyz-nature/naryn-pattern-bg.jpg');
        background-size: cover;
        background-position: center;
        padding: 60px 0;
        margin-top: 60px;
        position: relative;
        border-radius: 15px;
    }
    
    .related-products-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--bg-primary);
        opacity: 0.95;
        border-radius: 15px;
    }
    
    .related-products-section > * {
        position: relative;
        z-index: 1;
    }
    
    /* Map responsive iframe wrapper */
    .map-responsive {
        position: relative;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
        height: 0;
        overflow: hidden;
        max-width: 100%;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .map-responsive iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 15px;
    }
    
    @media (max-width: 768px) {
        .map-responsive {
            padding-bottom: 75%; /* Adjust for mobile */
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Kyrgyz Product Hero -->
<div class="kyrgyz-product-hero">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'frontend:home' %}" class="text-success">{% trans "Home" %}</a></li>
                <li class="breadcrumb-item"><a href="{% url 'frontend:products' %}" class="text-success">{% trans "Products" %}</a></li>
                <li class="breadcrumb-item active">{{ product.get_translated_name }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="container">
    <div class="row">
        <!-- Product Images -->
        <div class="col-lg-6 mb-4">
            <div class="product-image-container">
                {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.get_translated_name }}" class="img-fluid">
                {% else %}
                <img src="https://images.unsplash.com/photo-1590779033100-9f60a05a013d?ixlib=rb-4.0.3" alt="{{ product.get_translated_name }}" class="img-fluid">
                {% endif %}
            </div>
            
            <!-- Naryn Origin Badge -->
            <div class="mt-3">
                <span class="naryn-origin-badge">
                    <i class="bi bi-geo-alt-fill"></i>
                    {% trans "From Naryn Region" %}
                </span>
            </div>
            
            <!-- Quality Badges -->
            <div class="quality-badges">
                <div class="quality-badge">
                    <i class="bi bi-check-circle-fill"></i>
                    {% trans "Local Farmer" %}
                </div>
                <div class="quality-badge">
                    <i class="bi bi-droplet-fill"></i>
                    {% trans "Mountain Water" %}
                </div>
                <div class="quality-badge">
                    <i class="bi bi-flower1"></i>
                    {% trans "Traditional Methods" %}
                </div>
            </div>
        </div>
        
        <!-- Product Information -->
        <div class="col-lg-6">
            <h1 class="fw-bold mb-3">{{ product.get_translated_name }}</h1>
            
            <div class="d-flex align-items-center gap-3 mb-4">
                <a href="#farmer-info" class="text-muted text-decoration-none">
                    <i class="bi bi-person-circle me-1"></i>
                    {% trans "Sold by" %} {{ product.farmer.farm_name|default:product.farmer.username }}
                </a>
                <span class="text-muted">•</span>
                <span class="text-muted">
                    <i class="bi bi-tag me-1"></i>
                    {{ product.category.get_translated_name }}
                </span>
            </div>
            
            <div class="d-flex align-items-baseline gap-3 mb-4">
                <h2 class="text-success mb-0">{{ product.price|floatformat:2 }} сом</h2>
                <span class="text-muted">/ {{ product.unit }}</span>
            </div>
            
            <!-- Availability Status -->
            <div class="mb-4">
                {% if product.is_available and product.quantity_available > 0 %}
                <div class="d-flex align-items-center text-success">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <span class="fw-medium">{% trans "In Stock" %}</span>
                    <span class="text-muted ms-2">({{ product.quantity_available }} {{ product.unit }} {% trans "available" %})</span>
                </div>
                {% else %}
                <div class="d-flex align-items-center text-danger">
                    <i class="bi bi-x-circle-fill me-2"></i>
                    <span class="fw-medium">{% trans "Out of Stock" %}</span>
                </div>
                {% endif %}
            </div>
            
            <!-- Description -->
            <div class="mb-4">
                <h5 class="fw-bold">{% trans "Description" %}</h5>
                <p class="text-muted">{{ product.get_translated_description|linebreaks|default:_("No description available.") }}</p>
            </div>
            
            <!-- Add to Cart Section -->
            {% if user.is_authenticated and user.is_buyer %}
            <div class="d-flex gap-3 mb-4">
                <div class="input-group" style="max-width: 150px;">
                    <button class="btn btn-outline-secondary" type="button" onclick="decrementQuantity()">-</button>
                    <input type="number" id="quantity" class="form-control text-center" min="1" max="{{ product.quantity_available }}" value="1">
                    <button class="btn btn-outline-secondary" type="button" onclick="incrementQuantity()">+</button>
                </div>
                
                <button onclick="addToCartWithQuantity({{ product.id }})" class="btn btn-success btn-lg flex-grow-1" {% if not product.is_available or product.quantity_available <= 0 %}disabled{% endif %}>
                    <i class="bi bi-cart-plus me-2"></i>{% trans "Add to Cart" %}
                </button>
            </div>
            {% endif %}
            
            {% if not user.is_authenticated %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle-fill me-2"></i>
                {% trans "Please" %} <a href="{% url 'frontend:login' %}" class="alert-link">{% trans "login" %}</a> {% trans "to purchase this product." %}
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Farmer Information Section -->
    <div id="farmer-info" class="mt-5">
        <div class="farmer-card-kyrgyz">
            <div class="row align-items-center">
                <div class="col-md-2 text-center">
                    {% if product.farmer.profile_image %}
                    <img src="{{ product.farmer.profile_image.url }}" alt="{{ product.farmer.username }}" class="farmer-avatar-kyrgyz">
                    {% else %}
                    <img src="https://images.unsplash.com/photo-1606755351614-7b17a3a1f38d?ixlib=rb-4.0.3" alt="Kyrgyz Farmer" class="farmer-avatar-kyrgyz">
                    {% endif %}
                </div>
                
                <div class="col-md-10">
                    <h4 class="fw-bold">{{ product.farmer.get_full_name|default:product.farmer.username }}</h4>
                    <p class="text-muted mb-2">{{ product.farmer.farm_name }}</p>
                    
                    <div class="d-flex gap-3 align-items-center mb-3">
                        <span class="text-muted">
                            <i class="bi bi-geo-alt me-1"></i>
                            {{ product.farmer.farm_location|default:"Naryn Region" }}
                        </span>
                        <span class="badge bg-success">{% trans "Verified Farmer" %}</span>
                    </div>
                    
                    {% if user.is_authenticated %}
                    <div class="d-flex gap-2">
                        {% if product.farmer.phone_number %}
                        <a href="https://wa.me/{{ product.farmer.phone_number|cut:'+' }}" target="_blank" class="btn btn-success btn-sm">
                            <i class="bi bi-whatsapp me-1"></i> WhatsApp
                        </a>
                        <a href="tel:{{ product.farmer.phone_number }}" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-telephone me-1"></i> {% trans "Call" %}
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="mt-4">
                <h6 class="fw-bold">{% trans "About the Farmer" %}</h6>
                <p class="text-muted small">
                    {% if LANGUAGE_CODE == 'ky' %}
                        Мен {{ product.farmer.farm_location|default:"Нарын облусунда" }} үй-бүлөлүк ферма ишлетем. Биз традициялык ыкмаларды колдонуу менен сапаттуу азык-түлүк өндүрөбүз.
                    {% elif LANGUAGE_CODE == 'ru' %}
                        Я управляю семейной фермой в {{ product.farmer.farm_location|default:"Нарынской области" }}. Мы производим качественные продукты, используя традиционные методы.
                    {% else %}
                        I run a family farm in {{ product.farmer.farm_location|default:"Naryn region" }}. We produce quality food using traditional methods.
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <!-- Naryn Location Map Section -->
    <div class="naryn-map-section">
        <div class="map-overlay">
            <i class="bi bi-geo-alt-fill text-success me-1"></i>
            <strong>Naryn, Kyrgyzstan</strong>
        </div>
        
        <h4 class="fw-bold mb-4">{% trans "Product Origin" %}</h4>
        
        <div class="row align-items-center">
            <div class="col-md-6">
                <p class="text-muted">
                    {% if LANGUAGE_CODE == 'ky' %}
                        Бул продукт Нарын облусунун таза тоо аймагында өстүрүлгөн. Бийик тоолуу климат жана таза суу өзгөчө сапат берет.
                    {% elif LANGUAGE_CODE == 'ru' %}
                        Этот продукт выращен в чистых горных районах Нарынской области. Высокогорный климат и чистая вода придают особое качество.
                    {% else %}
                        This product is grown in the pristine mountain regions of Naryn Oblast. The high-altitude climate and pure water give it exceptional quality.
                    {% endif %}
                </p>
                
                <div class="d-flex gap-3 mt-3">
                    <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-thermometer-half text-success"></i>
                        <span class="small">1800-2500m</span>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-droplet text-success"></i>
                        <span class="small">{% trans "Glacier water" %}</span>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-sun text-success"></i>
                        <span class="small">300+ {% trans "sunny days" %}</span>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <!-- Embedded Google Map showing Naryn location -->
                <div class="map-responsive">
                    <iframe 
                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d189420.4304835574!2d75.72847577936833!3d41.43478920658371!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x38864e59e0c5280d%3A0xc4dd89b4dd581c8d!2sNaryn%2C%20Kyrgyzstan!5e0!3m2!1sen!2sus!4v1704810928374!5m2!1sen!2sus&markers=color:green%7C{{ product.farmer.farm_location|default:'Naryn' }}" 
                        width="100%" 
                        height="300" 
                        style="border:0;" 
                        allowfullscreen="" 
                        loading="lazy" 
                        referrerpolicy="no-referrer-when-downgrade">
                    </iframe>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Related Products Section -->
    <div class="related-products-section">
        <div class="container">
            <h3 class="fw-bold text-center mb-5">{% trans "More from Naryn Farmers" %}</h3>
            
            <div class="row g-4">
                {% for related in related_products %}
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="position-relative">
                            {% if related.image %}
                            <img src="{{ related.image.url }}" class="card-img-top" alt="{{ related.get_translated_name }}" style="height: 200px; object-fit: cover;">
                            {% else %}
                            <img src="https://images.unsplash.com/photo-1464226184884-fa280b87c399?ixlib=rb-4.0.3" class="card-img-top" alt="{{ related.get_translated_name }}" style="height: 200px; object-fit: cover;">
                            {% endif %}
                            
                            {% if user.is_authenticated and user.is_buyer %}
                            <button onclick="addToCart({{ related.id }})" class="btn btn-success btn-sm position-absolute top-0 end-0 m-2">
                                <i class="bi bi-plus-circle-fill"></i>
                            </button>
                            {% endif %}
                        </div>
                        
                        <div class="card-body">
                            <h6 class="card-title">{{ related.get_translated_name }}</h6>
                            <p class="card-text text-muted small">{{ related.get_translated_description|truncatechars:60 }}</p>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-success fw-bold">{{ related.price|floatformat:2 }} сом</span>
                                <a href="{% url 'frontend:product_detail' related.id %}" class="btn btn-sm btn-outline-success">
                                    {% trans "View" %}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="text-center mt-4">
                <a href="{% url 'frontend:products' %}?category={{ product.category.id }}" class="btn btn-success">
                    {% trans "See all" %} {{ product.category.get_translated_name }}
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    /* Pulse animation for location marker */
    .pulse-animation {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
        }
    }
</style>

<script>
    // Product quantity controls
    function incrementQuantity() {
        const input = document.getElementById('quantity');
        const max = parseInt(input.max);
        let value = parseInt(input.value) || 0;
        
        if (value < max) {
            input.value = value + 1;
        }
    }
    
    function decrementQuantity() {
        const input = document.getElementById('quantity');
        let value = parseInt(input.value) || 0;
        
        if (value > 1) {
            input.value = value - 1;
        }
    }
    
    function addToCartWithQuantity(productId) {
        const quantity = parseInt(document.getElementById('quantity').value) || 1;
        addToCart(productId, quantity);
    }
</script>
{% endblock %}